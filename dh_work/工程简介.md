---
layout:     post                        # 使用的布局(必填)
title:      工程简介                     # 标题(必填)
subtitle:   工作日志            # 副标题(必填)
date:       2019-08-23                  # 时间(必填)
author:     Mambo723                    # 作者(必填)
gitalk_enable: false                     # 是否开启评论(必填)
---
# 工程简介
##  工程概述
*  common目录：工程配置、游戏配置、错误码、用户数据相关
*  frameworks目录：第三方库、工具帮助类、网络支持、全局通用单例管理类（master）
*  hotfix目录：支持热更新相关的管理控制类
*  hall、games 业务相关代码
*  子游戏业务代码 controller、model、view 三者均继承 cc.Component, 并且挂在 prefab 中
*  启动子游戏时由外部加载prefab添加到场景中，onLoad 方法来驱动模块的初始化工作
*  由模块内部的用户操作、业务需求负责删除 prefab，onDestroy 方法来驱动模块反初始化的工作
*  保持 controller、model、view 三者各司其职业，高内聚低耦合为原则对外提供接口

补充：
*  与具体业务无关的控制类（通用、框架、基础支持），不必继承 cc.Component，所有权由 G 持有，生命周期在整个游戏运行期间存在
*  与具体业务相关的控制类(子游戏、大厅界面控制类)，必须继承 cc.Component，所有权、生命周期、初始化、反初始化由 ui 节点 node 来驱动
*  尽量不使用全局变量，若使用全局变量请使用 const 修饰，虽然项目使用 ts 代码，但是 es5 语法、js 语法同样可能造成名字污染问题

## 引擎定制
### 定制JavaScript引擎
- https://github.com/cocos-creator/engine
- 安装gulp工具 npm install -g gulp
- 编译 gulp build
### 定制Cocos2d-x-lite引擎
- https://github.com/cocos-creator/cocos2d-x-lite
- 初始化仓库 gulp init
- 编译模拟器 guld gen-simulator


使用定制引擎需要在编辑器中进行相应的设置，设置方法参考[官方文档](https://docs.cocos.com/creator/manual/zh/advanced-topics/engine-customization.html#23-%E5%9C%A8-cocos-creator-%E4%B8%AD%E9%85%8D%E7%BD%AE%E5%AE%9A%E5%88%B6%E7%89%88%E5%BC%95%E6%93%8E)

## 基础模块
### 一. 网络层
#### 1. 从 websocket 到 socket
- websocket适合H5开发，简单易学习
- C++socket易扩展，增加jsb支持js
- 两者均要处理消息拆包粘包、网络异常引发的断线重连

#### 2. protobufjs
- 由proto协议文件导出三种格式，ts、js、json
- 相比较其他数据流格式，protobuf效率最高
- 因大厅-子游戏架构及热更新模块设计下各模块要求相互解耦，故而最终选择生成 json
- 生成 json 的自动化工具 genProtoJson.bat 位于 hotfix_dev/devTool/pb_tool/genProtoJson.bat

#### 3. 数据加密
- 协议数据加密，首次采用md5，再次之后均采用aes，双向对称加解密
- 脚本加密，二进制混淆
- 资源加密，aes数据行加密

#### 4. 心跳、弱网感知及断线重连机制
todo

#### 5. 网络交互规范
todo

### 二. 热更新
#### 1. 热更新原理
- 依托于jsb.AssetManager
- 使用Downloader下载，支持并发下载，断点续传
- 使用jsb.fileUtils前置热更新目录


#### 2. 大厅-子游戏 架构下热更新模块的设计
参考[热更新编码规范](热更新编码规范)


## CocosCreator 大厅-子游戏架构
### games/base 游戏公共模块详解（功能、使用方法、注意事项）
#### game_hall
todo

#### models
RoomModel todo

#### main
* GameRoot
* GameRouter
* gamesProtocol
* RoomInterface
* selectRoom
等等...

#### GameMenuUI
* 代码：GameMenuUI.ts
* 描述: 预制存放game/base/comBtnItem/ 主要负责处理游戏内的顶部按钮，目前包括 返回、电量、信号、下拉、以及下拉内的各项功能  
       在创建时需要提供一个节点(创建于游戏game预制内)，在gameRoot中 子游戏创建时会查询子游戏game预制内的"*gameMenuUI*"节点
* 功能：  
    - 规则  
      纯预制实现,子游戏/hall/prefabs/popup/rule  
    - 设置  
      代码：musicEffect.ts  
      调用各自游戏预制,子游戏/hall/prefabs/popup/setting。  
      功能： 设置游戏内的音量以及弹幕的显示  
    - 设置筹码  
      代码：SelectChip.ts  
      调用各自游戏预制(押注类游戏才有该预制-*百家乐* *红黑* *龙虎斗* *百人牛牛* ) 子游戏/hall/prefabs/popup/SelectChip  
      功能：更改游戏内的下注筹码数值  
       + SelectChip.ts中包含4部分代码。  
             1. SelectChip UI操作部分  
             2. SelectChipModel 数据处理   
             3. chipInfo 筹码模型   
             4. chipItem 单颗筹码操作类  
         
    - 下注历史  
    - 信号  
    - 电量  
    - ...

#### 跑马灯
* 代码：GameBroadcast.ts  
* 描述：预制存放于game/base/broadcast 动态创建于大厅、次级、游戏内，负责展示EMsgShowMode.EShowRoll类型的消息  
      创建时会查询对应预制内是否有"*Broadcast*"节点   
* 功能：根据接收到的消息和范围，本地筛选当前场景是否符合本条消息的播放条件，符合就加入到播放队列 -- 下同

#### 弹幕
* 代码：GameBarrage.ts  
* 描述：预制存放于game/base/barrage 动态创建于游戏内，负责展示EMsgShowMode.EShowScreenBarrage类型的消息  
      创建时会查询game预制内是否有"*Barrage*"节点，有就挂载该节点下，没有则不创建。弹幕播放范围根据"*Barrage*"节点的宽高决定  
      弹幕从右往左出现。  

#### 其他
* 扑克相关
* 筹码相关
等等...

## 内存管理
- 队列管理：公共资源常驻内存，模块资源依次加入队列
- 释放策略：根据阈值权重或者优先级，决定释放最应该释放的资源


## 全局变量
todo


## 自定义构建编译流程
todo


## 自动化工具简介
自动化工具大都位于：hotfix_dev/devTool

* check_useless_res : 检查子游戏未引用的资源
* encrypt_tool : 用于自定义构建流程中的资源加密
* error_codes : 将错误码文案配表转换成 ts 配置
* hotfix_tool : 用于热更新包生成工具，参考[热更新编码规范](热更新编码规范)
* pb_tool : 由proto协议文件导出 json
* psd2node : 将美术 psd 文件导出生成 CocosCreator Prefab 文件，参考 [pas2node](pas2node)
* transplant_subproj : 子游戏移植工具，参考[子游戏移植工具](子游戏移植工具)
* ttf_tool : 字体瘦身工具
* ccfishing_tool : 捕鱼游戏中使用的自动化工具，参考[捕鱼项目结构、自动化工具及相关规范](捕鱼项目结构、自动化工具及相关规范)

自动化工具的使用若有疑问请咨询平台组开发人员
